<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DWG Viewer - GitHub Pages</title>

<!-- ODA WebViewer -->
<script src="https://webviewer.opendesign.com/oda.js"></script>

<style>
body{
    margin:0;
    font-family:Arial;
    background:#f0f0f0;
}

.header{
    background:#1f1f1f;
    color:white;
    padding:10px;
    text-align:center;
}

#container{
    display:flex;
    height:calc(100vh - 60px);
}

#sidebar{
    width:280px;
    background:white;
    padding:10px;
    border-right:1px solid #ddd;
}

#viewerDiv{
    flex:1;
    width:100%;
    height:100%;
}

button, input{
    width:100%;
    margin:6px 0;
    padding:8px;
}

#status{
    font-size:12px;
    color:green;
}
</style>
</head>

<body>

<div class="header">
<h3>DWG Viewer (Works on GitHub Pages)</h3>
</div>

<div id="container">

<div id="sidebar">
<b>Select DWG:</b>
<input type="file" id="fileInput" accept=".dwg,.dxf"/>

<button onclick="fitToScreen()">Fit to Screen</button>
<button onclick="resetView()">Reset View</button>

<hr>
<div id="status">Initializing viewer...</div>
</div>

<div id="viewerDiv"></div>

</div>

<script>
let viewer = null;
let viewerReady = false;

async function initViewer(){
    const status = document.getElementById("status");
    status.innerText = "Initializing viewer...";

    try {
        viewer = await ODA.initialize({
            container: "viewerDiv",
            backgroundColor: [255,255,255,255],
            wasmPath: "https://webviewer.opendesign.com/wasm/"
        });

        viewerReady = true;
        status.innerText = "Viewer ready. Upload a DWG file.";

    } catch (err) {
        status.innerText = "Viewer FAILED to start: " + err.message;
        console.error("Viewer init error:", err);
    }
}

initViewer();

document.getElementById("fileInput").addEventListener("change", async (e)=>{
    const file = e.target.files[0];
    const status = document.getElementById("status");

    if(!file) return;

    if (!viewerReady || !viewer) {
        status.innerText =
          "Viewer not ready yet â€” please wait 5 seconds and try again.";
        return;
    }

    status.innerText = "Loading " + file.name + " ...";

    try{
        const buffer = await file.arrayBuffer();
        await viewer.loadFromArrayBuffer(buffer, file.name);
        status.innerText = "Loaded successfully: " + file.name;
        viewer.fitToScreen();
    }
    catch(err){
        status.innerText = "ERROR loading DWG: " + err.message;
        console.error("DWG Load Error:", err);
    }
});

function fitToScreen(){
    if(viewer) viewer.fitToScreen();
}

function resetView(){
    if(viewer) viewer.resetView();
}
</script>

</body>
</html>

